{% extends 'base.html' %}

{% block title %}{{ project.project_name }} - 프로젝트 상세{% endblock %}

{% block content %}
    <template id="task-template">
        <li>
            <div class="task-summary">
                <span class="task-name"></span>
                <small class="task-status"></small>
            </div>
            <div class="task-details" data-task-id="">
                <div class="view-mode">
                    <p><strong>기간:</strong> <span class="task-dates"></span></p>
                    <button class="edit-task-btn">수정</button>
                </div>
                <form class="edit-task-form" style="display: none;">
                    <input type="text" name="task_name" required>
                    <div class="grid">
                        <input type="datetime-local" name="start_date" required>
                        <input type="datetime-local" name="end_date" required>
                    </div>
                    <button type="submit">저장</button>
                    <button type="button" class="cancel-edit-btn">취소</button>
                </form>

                <hr>
                <div>
                    <strong>상태 변경/삭제:</strong>
                    <form class="update-status-form" method="POST" style="display: inline;">
                        <select name="status" class="task-status-select">
                            <option value="대기">대기</option>
                            <option value="진행 중">진행 중</option>
                            <option value="완료">완료</option>
                        </select>
                    </form>
                    <form class="delete-task-form" method="POST" style="display: inline;">
                        <button type="submit">삭제</button>
                    </form>
                </div>
                <hr>
                <div class="comment-section">
                    <strong>댓글</strong>
                    <ul class="comment-list"><li>작성된 댓글이 없습니다.</li></ul>
                    <form class="comment-form" method="POST">
                        <input type="text" name="content" placeholder="댓글을 입력하세요..." required>
                        <button type="submit">작성</button>
                    </form>
                </div>
            </div>
        </li>
    </template>
    <!-- /template -->

    <article>
        <hgroup>
            <h2 id="project-title-display">프로젝트: {{ project.project_name }}</h2>
            {% if current_user.id == project.created_by %}
                <button id="edit-project-btn">수정</button>
            {% endif %}
            <p><strong>기간:</strong> {{ project.start_date.replace('T', ' ') }} ~ {{ project.end_date.replace('T', ' ') }}</p>
        </hgroup>
        <dialog id="edit-project-modal">
            <article>
                <header>
                    <a href="#close" aria-label="Close" class="close"></a>
                    <strong>프로젝트 정보 수정</strong>
                </header>
                <form id="edit-project-form">
                    <label for="modal_project_name">프로젝트 이름</label>
                    <input type="text" id="modal_project_name" name="project_name" value="{{ project.project_name }}" required>
                    
                    <div class="grid">
                        <div>
                            <label for="modal_start_date">시작일</label>
                            <input type="datetime-local" id="modal_start_date" name="start_date" value="{{ project.start_date }}" required>
                        </div>
                        <div>
                            <label for="modal_end_date">종료일</label>
                            <input type="datetime-local" id="modal_end_date" name="end_date" value="{{ project.end_date }}" required>
                        </div>
                    </div>
                    
                    <footer>
                        <button type="submit">저장</button>
                    </footer>
                </form>
            </article>
        </dialog>
        <div class="grid">
            <div>
                <hgroup>
                    <strong id="task-progress-text">태스크 진행률: {{ task_progress }}%</strong>
                </hgroup>
                <progress id="task-progress-bar" value="{{ task_progress }}" max="100"></progress>
            </div>
            <div>
                <hgroup>
                    <strong>시간 진행률: {{ time_progress }}%</strong>
                    <small id="countdown-timer" data-start-date="{{ project.start_date }}" data-end-date="{{ project.end_date }}"></small>
                </hgroup>
                <progress value="{{ time_progress }}" max="100"></progress>
            </div>
        </div>
    </article>

    <article class="gantt-container">
        <h3>프로젝트 타임라인</h3>
        <div class="chart-wrapper">
            <canvas id="gantt_chart_div" data-project-id="{{ project.id }}"></canvas>
        </div>
    </article>

    <div class="grid-container" data-current-user="{{ current_user.username }}" data-user-role="{{ user_role }}">
        <article>
            <h3>작업 목록</h3>
            <ul class="task-list">
                {% for task in tasks %}
                <li>
                    <div class="task-summary">
                        <span>{{ task.task_name }}</span>
                        <small>상태: {{ task.status }}</small>
                    </div>

                    <div class="task-details" data-task-id="{{task.id}}">
                        <div class="view-mode">
                            <p>
                                <strong>기간:</strong>
                                <span class="task-dates">{{ task.start_date.replace('T', ' ') }} ~ {{ task.end_date.replace('T', ' ') }}</span>
                            </p>
                            <button class="edit-task-btn">수정</button>
                        </div>
                        <form class="edit-task-form" style="display: none;">
                            <input type="text" name="task_name" value="{{ task.task_name }}" required>
                            <div class="grid">
                                <input type="datetime-local" name="start_date" value="{{ task.start_date }}" required>
                                <input type="datetime-local" name="end_date" value="{{ task.end_date }}" required>
                            </div>
                            <button type="submit">저장</button>
                            <button type="button" class="cancel-edit-btn">취소</button>
                        </form>

                        <hr>
                        <div>
                            <strong>상태 변경/삭제:</strong>
                            <form class="update-status-form" action="{{ url_for('project.update_task_status', task_id=task.id) }}" method="POST" style="display: inline;">
                                <select name="status" class="task-status-select">
                                    <option value="대기" {% if task.status == '대기' %}selected{% endif %}>대기</option>
                                    <option value="진행 중" {% if task.status == '진행 중' %}selected{% endif %}>진행 중</option>
                                    <option value="완료" {% if task.status == '완료' %}selected{% endif %}>완료</option>
                                </select>
                            </form>
                            <form class="delete-task-form" action="{{ url_for('project.delete_task', task_id=task.id) }}" method="POST" style="display: inline;">
                                <button type="submit">삭제</button>
                            </form>
                        </div>
                        <hr>
                        <div class="comment-section">
                            <strong>댓글</strong>
                            <ul class="comment-list">
                                </ul>
                            <form class="comment-form" method="POST">
                                <input type="text" name="content" placeholder="댓글을 입력하세요..." required>
                                <button type="submit">작성</button>
                            </form>
                        </div>
                    </div>
                </li>
            {% else %}
                <li class="no-tasks">등록된 작업이 없습니다.</li>
            {% endfor %}
            </ul>
        </article>
        
        <article>
            <h3>새 작업 추가</h3>
            <form id="create-task-form" action="{{ url_for('project.create_task', project_id=project.id) }}" method="POST">
                <label for="task_name">작업 이름:</label>
                <input type="text" id="task_name" name="task_name" required>
                
                <label for="task_start_date">시작일</label>
                <input type="datetime-local" id="task_start_date" name="start_date" value="{{ current_time }}" required>
                <label for="task_end_date">종료일</label>
                <input type="datetime-local" id="task_end_date" name="end_date" value="{{ current_time }}" required>

                <button type="submit">추가하기</button>
            </form>
            <hr>
            <h3>프로젝트 관리</h3>
            {% if current_user.id == project.created_by %}
                <form action="{{ url_for('project.delete_project', project_id=project.id) }}" method="POST">
                    <button class="secondary" onclick="return confirm('정말로 이 프로젝트를 삭제하시겠습니까? 되돌릴 수 없습니다.');">프로젝트 삭제</button>
                </form>
            {% else %}
                <p>프로젝트 삭제는 생성자만 가능합니다.</p>
            {% endif %}
        </article>
    </div>

    <script defer src="{{ url_for('static', filename='js/countdown.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/gantt.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}